# 建議規劃與設計思路 — 實現 MVP 功能與解決遺留問題

---

## 🎯 總目標

- **實現功能：**
  1. Agent 具有持續對話、記憶過往對話的能力。
  2. 支援多種工具之間的回傳資料互用。
  3. 引入 Multi-Agent 架構，實現多 Agent 協作。
  4. 優化 RAG，提升檢索與生成的準確性與多樣性。

- **解決遺留問題：**
  - 上下文關聯不夠準確。
  - 主題切換與深入度不足。
  - 回答卡住，陷入無限循環。

---

## 📝 設計與開發建議

### 1. **持續對話與記憶能力**
- **問題：** 上下文關聯不夠準確，對話記憶力有限。
- **解法：**
  - **記憶機制：**
    - 使用 `MemorySaver` 保存完整對話歷史。
    - 引入「對話摘要」功能，將長對話壓縮成摘要，減少 token 消耗。
  - **Prompt 優化：**
    - 在 Prompt 中加入「對話摘要」與「本輪問題重點」。
    - 明確要求 LLM 參考上下文，避免重複回應。
  - **技術實現：**
    - 在 `state.py` 中新增 `conversation_summary` 欄位，用於存儲對話摘要。
    - 在 `nodes.py` 的 Prompt 構建邏輯中，動態插入摘要。

### 📋 Checklist

#### 持續對話與記憶能力
    - [ ] 實現對話摘要功能，將長對話壓縮成摘要。
    - [ ] 優化 Prompt，加入摘要與本輪問題重點。
    - [ ] 測試上下文記憶的準確性，確保對話連貫性。


---

### 2. **多工具之間的回傳資料互用**
- **問題：** 工具之間的數據傳遞與協作尚未實現。
- **解法：**
  - **工具整合：**
    - 引入景點搜尋 API，返回景點資訊。
    - 引入行程生成工具，根據搜尋結果生成行程。
  - **數據傳遞：**
    - 設計工具之間的數據傳遞邏輯，確保搜尋結果能傳遞給行程生成工具。
    - 在 `state.py` 中新增 `tool_results` 欄位，用於存儲工具的輸出。
  - **技術實現：**
    - 在 `graph.py` 中新增工具節點，實現工具之間的數據流動。
    - 測試工具輸入與輸出的正確性。

### 📋 Checklist

#### 多工具整合
    - [ ] 整合景點搜尋 API，返回景點資訊。
    - [ ] 整合行程生成工具，根據搜尋結果生成行程。
    - [ ] 設計工具之間的數據傳遞邏輯。
    - [ ] 測試工具輸入與輸出的正確性，確保數據互用。


---

### 3. **Multi-Agent 架構**
- **問題：** 單一 Agent 無法處理複雜任務。
- **解法：**
  - **引入多 Agent：**
    - 設計多個專業化 Agent（如景點推薦 Agent、行程規劃 Agent）。
    - 使用中央協調器（Coordinator）管理多 Agent 的協作。
  - **技術實現：**
    - 在 `graph.py` 中新增協調器節點，負責分配任務給不同 Agent。
    - 測試多 Agent 協作的穩定性。


### 📋 Checklist

#### Multi-Agent 架構
- [ ] 設計多 Agent 協作邏輯，分工處理不同任務。
- [ ] 實現中央協調器（Coordinator），負責分配任務給不同 Agent。
- [ ] 測試多 Agent 的穩定性與協作效率。

---

### 4. **進階 RAG 優化**
- **問題：** 檢索結果不夠準確，生成內容重複。
- **解法：**
  - **知識庫擴充：**
    - 增加文件數量（10-20 份），覆蓋更多主題。
  - **檢索策略：**
    - 合併最近 2~3 輪 query，提升主題聚合度。
    - 引入 Re-ranking（重新排序檢索結果），優先返回相關性高的文件。
    - 實現混合檢索（向量 + 關鍵字）。
  - **Prompt 優化：**
    - 在 Prompt 中加入「若無新資訊，請主動告知」。
    - 動態插入檢索到的文件內容，避免重複回應。

### 📋 Checklist

#### 進階 RAG 優化
- [ ] 增加知識庫文件（10-20 份），覆蓋更多主題。
- [ ] 優化 Chunk 策略（調整 size 和 overlap）。
- [ ] 引入 Re-ranking（重新排序檢索結果），優先返回相關性高的文件。
- [ ] 實現混合檢索（向量 + 關鍵字）。
- [ ] 測試檢索與生成的準確性，避免重複回應。

---

## 🛠️ 開發建議與實作順序

### **Day 3**
1. **持續對話與記憶能力**
   - 實現對話摘要功能，並測試摘要的準確性。
   - 優化 Prompt，加入摘要與本輪問題重點。

2. **多工具整合**
   - 整合景點搜尋 API，測試輸入與輸出。
   - 設計工具之間的數據傳遞邏輯。

### **Day 4**
3. **Multi-Agent 架構**
   - 設計多 Agent 協作邏輯，實現中央協調器。
   - 測試多 Agent 的穩定性與協作效率。

4. **進階 RAG 優化**
   - 增加知識庫文件，測試檢索效果。
   - 引入 Re-ranking 與混合檢索，提升檢索準確性。


## 🚀 結論

- **優先實現：** 持續對話與記憶能力、多工具整合。
- **進階功能：** Multi-Agent 架構、進階 RAG 優化。
- **解決遺留問題：** 通過 Prompt 優化與檢索策略改進，提升上下文關聯性與主題切換能力。

按照以上規劃，逐步完成 MVP 開發，並確保功能穩定性與可測試性。