# 旅遊規劃 AI Agent — Day 3-4 開發規劃與階段目標

---

## Day 3-4 開發總覽

- 目標：逐步實現 MVP，涵蓋持續對話記憶、多工具整合、Multi-Agent 架構、進階 RAG，並解決上下文與回應重複等遺留問題。

---

## Day 3 階段一：持續對話記憶能力

### 階段目標
- 實現 Agent 能記住過往對話，維持上下文連貫。
- 引入對話摘要機制，減少 token 消耗。

### 開發步驟
1. **新增 `conversation_summary` 欄位**
   - 在 `state.py` 中新增 `conversation_summary` 欄位，用於存儲對話摘要。
   - 確保該欄位能在對話狀態中持久化。

2. **實現對話摘要功能**
   - 在 `nodes.py` 中新增摘要生成邏輯，使用 LLM 將長對話壓縮成摘要。
   - 確保摘要能動態更新，並與完整對話歷史保持一致。

3. **優化 Prompt**
   - 修改 Prompt 構建邏輯，將摘要與本輪問題重點動態插入。
   - 確保 Prompt 聚焦於當前對話主題，避免重複回應。

4. **測試上下文記憶**
   - 編寫測試用例，模擬多輪對話，檢查摘要生成與上下文記憶的準確性。
   - 確保摘要能正確反映對話歷史，並提升生成回應的連貫性。


### Checklist
- [X] 在 `state.py` 中新增 `conversation_summary` 欄位。
- [X] 實現對話摘要功能，將長對話壓縮成摘要。
- [X] 優化 Prompt，加入摘要與本輪問題重點。
- [X] 在 `nodes.py` 的 Prompt 構建邏輯中，動態插入摘要。
- [X] 測試上下文記憶的準確性，確保對話連貫性。

---

## Day 3 階段二：多工具整合

### 階段目標（更新）
- 整合旅遊景點搜尋 API 與行程生成工具。
- 採用主流 Agent 架構（如 LangChain Agent、OpenAI Function Calling），實現工具註冊與 LLM function calling。
- 工具間資料互用，數據流動順暢。

### 開發步驟（更新）

1. **分析現有需求與工具接口**
   - 明確每個工具的功能、輸入/輸出格式。
   - 在 `nodes.py` 或 `tools.py` 定義工具函數及 function schema（如 name、description、參數）。
   - 工具函數只負責業務邏輯，不負責流程判斷。

2. **優化狀態結構**
   - 在 `state.py` 優化 `tool_results` 欄位為 dict 結構，支援多工具結果。

3. **工具註冊與 Agent 初始化**
   - 在 `graph.py` 或 `agent.py` 引用工具，包裝成 Tool 並註冊給 Agent。
   - 定義 Agent decision node，將狀態交給 Agent，由 LLM function calling 決定是否調用工具。

4. **主流程設計**
   - `graph.py` 只註冊一個 Agent decision node，主流程由 LLM 控制。
   - 保留工具 node 實作，方便擴充與維護。

5. **設計工具間數據流動邏輯**
   - 明確定義工具間資料流動，確保結果能互用。

6. **測試 function calling 與多輪互動**
   - 編寫單元測試與整合測試，模擬多種情境，驗證工具調用與資料流動。

7. **文件與註解補充**
   - 為工具、節點、主流程補充註解與開發文檔，便於後續維護與擴充。

### Checklist（更新）
- [X] 景點搜尋 API 整合，返回景點資訊。
- [X] 行程生成工具整合，採用 function calling 架構。
- [X] `state.py` 優化 `tool_results` 欄位（dict 結構）。
- [X] 工具註冊給 Agent/LLM，明確 schema。
- [X] 主流程改為 LLM function calling，讓 LLM 主動選擇調用工具。
- [X] 測試工具調用與資料流動正確性。
- [X] 多輪互動測試，資訊不足時由 LLM 主動詢問。

---

## Day 4 階段一：Multi-Agent 架構

### 階段目標
- 引入多 Agent，分工處理複雜任務。
- 實現中央協調器，管理多 Agent 協作。

### 1. 設計多 Agent 協作邏輯
- 明確分工：如「景點推薦 Agent」、「行程規劃 Agent」。
- 定義每個 Agent 的職責、輸入/輸出格式。

   ### 1. 規劃代理人（Planner Agent）
   - 職責：理解使用者需求，拆解任務，協調其他 Agent。
   - 輸入：使用者問題、對話上下文。
   - 輸出：子任務分派指令、協作流程控制。

   ### 2. 檢索代理人（Retriever Agent）
   - 職責：負責知識庫、RAG、外部 API 資料查詢。
   - 輸入：Planner Agent 分派的檢索任務（如：查找滑雪課程、溫泉、美食等）。
   - 輸出：結構化檢索結果（如文件內容、API 回應）。

   ### 3. 景點搜尋代理人（Attraction Agent）
   - 職責：專責景點、活動、交通查詢。
   - 輸入：Planner Agent 分派的景點/交通查詢任務。
   - 輸出：景點清單、交通方案、活動推薦（結構化格式）。

   ### 4. 行程生成代理人（Itinerary Agent）
   - 職責：根據檢索和景點資料，自動生成行程建議。
   - 輸入：Retriever Agent、Attraction Agent 的資料。
   - 輸出：完整行程規劃（如 Day 1~Day N 活動、交通、住宿、餐飲）。

   ### 5. 評估/優化代理人（Evaluator Agent）
   - 職責：根據使用者偏好、預算、時間等優化行程方案。
   - 輸入：Itinerary Agent 生成的初步行程、使用者偏好/限制。
   - 輸出：優化後的行程建議、評分、調整建議。

   ---

   ### 開發建議
   - 每個 Agent 節點獨立實作，明確定義輸入/輸出格式。
   - 中央協調器（Coordinator）負責任務分派與流程控制。
   - 各 Agent 回傳結構化結果，便於後續整合與優化。
   - 測試多 Agent 協作流程，確保數據流動與回應整合正確。

### 2. 實現中央協調器（Coordinator）
- 新增協調器節點，負責分配任務給各 Agent。
- 設計協調器的路由邏輯（根據任務類型分派）。

### 3. 在 `graph.py` 中新增協調器節點
- 使用 LangGraph 或 CrewAI 等框架，將協調器與多個 Agent 節點串接。
- 設定 entry point 為協調器。

### 4. 實作各 Agent 節點
- 在 `nodes.py` 中分別實作景點推薦 Agent、行程規劃 Agent等。
- 每個 Agent 節點只負責自身任務，回傳結構化結果。

### 5. 設計數據傳遞與回應整合
- 協調器負責收集各 Agent 回應，整合成最終回覆。
- 確保資料格式一致，方便後續擴充。

### 6. 測試多 Agent 的穩定性與協作效率
- 編寫單元測試與整合測試，模擬多種協作情境。
- 驗證數據流動、回應整合的正確性。

---

### Checklist
- [ ] 設計多 Agent 協作邏輯，分工處理不同任務（如景點推薦、行程規劃）。
- [ ] 實現中央協調器（Coordinator），負責分配任務給不同 Agent。
- [ ] 在 `graph.py` 中新增協調器節點。
- [ ] 測試多 Agent 的穩定性與協作效率。
- [ ] 確保 Agent 之間的數據傳遞與回應整合正確。

---

## Day 4 階段二：進階 RAG 優化

### 階段目標
- 擴充知識庫與優化檢索策略。
- 提升回應準確性與多樣性，避免重複回應。

### Checklist
- [ ] 增加知識庫文件（10-20 份），覆蓋更多主題。
- [ ] 優化 Chunk 策略（調整 size 和 overlap）。
- [ ] 引入 Re-ranking（重新排序檢索結果），優先返回相關性高的文件。
- [ ] 實現混合檢索（向量 + 關鍵字）。
- [ ] 在 `nodes.py` 中加入檢索結果去重邏輯。
- [ ] 測試檢索與生成的準確性，避免重複回應。
- [ ] 確保 RAG 優化後，多輪對話的主題聚合度提升。

---

## 開發建議

- 每階段完成後，務必進行單元測試與整合測試，確保功能穩定。
- 階段性成果可用於快速驗證，便於後續擴充與優化。
- 按照 checklist 逐項落實，確保每個核心功能都可用且易於維護。

---