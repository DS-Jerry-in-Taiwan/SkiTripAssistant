# 旅遊規劃 AI Agent — Day 3-4 開發規劃與階段目標

---

## Day 3-4 開發總覽

- 目標：逐步實現 MVP，涵蓋持續對話記憶、多工具整合、Multi-Agent 架構、進階 RAG，並解決上下文與回應重複等遺留問題。

---

## Day 3 階段一：持續對話記憶能力

### 階段目標
- 實現 Agent 能記住過往對話，維持上下文連貫。
- 引入對話摘要機制，減少 token 消耗。

### 開發步驟
1. **新增 `conversation_summary` 欄位**
   - 在 `state.py` 中新增 `conversation_summary` 欄位，用於存儲對話摘要。
   - 確保該欄位能在對話狀態中持久化。

2. **實現對話摘要功能**
   - 在 `nodes.py` 中新增摘要生成邏輯，使用 LLM 將長對話壓縮成摘要。
   - 確保摘要能動態更新，並與完整對話歷史保持一致。

3. **優化 Prompt**
   - 修改 Prompt 構建邏輯，將摘要與本輪問題重點動態插入。
   - 確保 Prompt 聚焦於當前對話主題，避免重複回應。

4. **測試上下文記憶**
   - 編寫測試用例，模擬多輪對話，檢查摘要生成與上下文記憶的準確性。
   - 確保摘要能正確反映對話歷史，並提升生成回應的連貫性。


### Checklist
- [X] 在 `state.py` 中新增 `conversation_summary` 欄位。
- [X] 實現對話摘要功能，將長對話壓縮成摘要。
- [X] 優化 Prompt，加入摘要與本輪問題重點。
- [X] 在 `nodes.py` 的 Prompt 構建邏輯中，動態插入摘要。
- [X] 測試上下文記憶的準確性，確保對話連貫性。

---

## Day 3 階段二：多工具整合

### 階段目標
- 整合旅遊景點搜尋 API 與行程生成工具。
- 實現工具間資料互用，確保數據流動順暢。

1. **分析現有需求與工具接口**
   - 明確景點搜尋 API（如 Tavily Search、Google Search）與行程生成工具的功能與輸入/輸出格式。
   - 確認各工具的 Python 調用方式與回傳資料結構。

2. **在 `state.py` 新增 `tool_results` 欄位**
   - 定義 `tool_results`，用於存儲各工具的執行結果，便於後續數據流動與互用。

3. **實作景點搜尋 API 整合**
   - 新增工具函數（如 `search_attractions(query)`），串接外部 API，回傳景點資訊。
   - 測試 API 回傳格式，確保能正確解析並存入 `tool_results`。

4. **實作行程生成工具整合**
   - 新增行程生成函數（如 `generate_itinerary(attractions, preferences)`），根據景點搜尋結果與使用者偏好生成行程。
   - 將生成結果存入 `tool_results`。

5. **設計工具間數據傳遞邏輯**
   - 明確定義各工具的輸入/輸出，設計數據流動順序（如：先搜尋景點，再生成行程）。
   - 在主流程或節點函數中串接工具，確保資料能順利流動。

6. **在 `graph.py` 新增工具節點**
   - 為每個工具建立獨立節點，並設計節點間的數據流動（如：搜尋節點 → 行程生成節點）。
   - 測試節點串接，確保工具間資料互用。

7. **撰寫測試用例**
   - 編寫單元測試與整合測試，模擬多種輸入情境，檢查工具輸入/輸出正確性。
   - 驗證 `tool_results` 欄位能正確反映各工具執行結果。

8. **文件與註解補充**
   - 為新工具函數、節點與數據流動邏輯補充註解與開發文檔，便於後續維護與擴充。

### Checklist
- [X] 整合景點搜尋 API（Tavily Search 或 Google Search），返回景點資訊。
- [ ] 整合行程生成工具，根據搜尋結果生成行程。
- [X] 在 `state.py` 中新增 `tool_results` 欄位，用於存儲工具輸出。
- [X] 設計工具之間的數據傳遞邏輯。
- [X] 在 `graph.py` 中新增工具節點，實現工具之間的數據流動。
- [X] 測試工具輸入與輸出的正確性，確保數據互用。

---

## Day 4 階段一：Multi-Agent 架構

### 階段目標
- 引入多 Agent，分工處理複雜任務。
- 實現中央協調器，管理多 Agent 協作。

### Checklist
- [ ] 設計多 Agent 協作邏輯，分工處理不同任務（如景點推薦、行程規劃）。
- [ ] 實現中央協調器（Coordinator），負責分配任務給不同 Agent。
- [ ] 在 `graph.py` 中新增協調器節點。
- [ ] 測試多 Agent 的穩定性與協作效率。
- [ ] 確保 Agent 之間的數據傳遞與回應整合正確。

---

## Day 4 階段二：進階 RAG 優化

### 階段目標
- 擴充知識庫與優化檢索策略。
- 提升回應準確性與多樣性，避免重複回應。

### Checklist
- [ ] 增加知識庫文件（10-20 份），覆蓋更多主題。
- [ ] 優化 Chunk 策略（調整 size 和 overlap）。
- [ ] 引入 Re-ranking（重新排序檢索結果），優先返回相關性高的文件。
- [ ] 實現混合檢索（向量 + 關鍵字）。
- [ ] 在 `nodes.py` 中加入檢索結果去重邏輯。
- [ ] 測試檢索與生成的準確性，避免重複回應。
- [ ] 確保 RAG 優化後，多輪對話的主題聚合度提升。

---

## 開發建議

- 每階段完成後，務必進行單元測試與整合測試，確保功能穩定。
- 階段性成果可用於快速驗證，便於後續擴充與優化。
- 按照 checklist 逐項落實，確保每個核心功能都可用且易於維護。

---